import type { ComponentType, JSXElement } from '../../jsx';
import { Defs, Ellipse, getElementBounds, Group, Path } from '../../jsx';
import {
  BtnAdd,
  BtnRemove,
  BtnsGroup,
  ItemIcon,
  ItemsGroup,
  ShapesGroup,
} from '../components';
import { FlexLayout } from '../layouts';
import { getColorPrimary, getPaletteColor, getThemeColors } from '../utils';
import { registerStructure } from './registry';
import type { BaseStructureProps } from './types';

// W 型路径参数
const DX = 240;
const DY = 130;
const ITEM_TO_PATH_GAP = 70;
// W 型路径宽度
const W_PATH_W = 6;
// 原始装饰性 Path 的 D 属性
const DECO_PATH_1 =
  'M128.57111,37.53688031C128.56837,37.70933938,128.55182,37.88128519,128.52164,38.05107307C128.51871,38.06750667,128.51727,38.08345848,128.51727,38.10014987C128.51727,38.15397322,128.50134,38.20659265,128.4715,38.25137855L128.46347,38.26342205C128.42839,38.31606095,128.40965,38.37790695,128.40965,38.44116795L128.40965,38.44926205C128.40965,38.48657985,128.40363,38.523653949999996,128.39183,38.55905695L128.36729,38.63269685C128.35966,38.655595149999996,128.35121,38.67787935,128.34137,38.69991635C128.30688,38.77707875,128.26949,38.85289535,128.22925,38.92720615C128.20641,38.96935395,128.18675,39.01286745,128.17159,39.05833765C128.15099,39.12011925,128.12224,39.17887975,128.08612,39.23306755L128.06708,39.26162095C128.04431,39.29575965,128.02371,39.33128145,128.00537,39.36798005L127.95866,39.46140525C127.93642,39.50588655,127.91248,39.54949715,127.88689,39.59214095L127.787,39.758619350000004C127.77161,39.78427025,127.75314,39.80793615,127.73198,39.82908705C127.71735,39.843708050000004,127.70441,39.85900405,127.69238,39.87582035C127.56937,40.04771785,127.43713,40.21284035,127.2963,40.37046765C127.28519,40.38289805,127.27946,40.39846345,127.27946,40.41513275C127.27946,40.43301105,127.27235,40.45015715,127.25971,40.46279935L127.0294,40.69311475C127.01722,40.70529985,127.00069,40.71214535,126.98346,40.71214535C126.96622,40.71214535,126.94971,40.71899085,126.93752,40.73117545L126.74128,40.92741755L126.64842,41.02027035C126.6028,41.06589385,126.55278,41.10690045,126.49909,41.14269325L126.49036,41.14851335C126.44249,41.18043135,126.39789,41.21699815,126.3572,41.25768185C126.29078,41.32410145,126.21407,41.37938025,126.13006,41.42139005L126.12121,41.42581515C126.06828,41.45227675,126.01843,41.48361495,125.971,41.51898335C125.89643,41.57457165,125.82078,41.62866785,125.74407,41.68123765C125.69176,41.71708395,125.63953,41.75372365,125.58881,41.79177375C125.4961,41.86130715,125.39987,41.92601345,125.30051,41.98563485L125.21208,42.03869055C125.19107,42.05129525,125.16998,42.06375595,125.1488,42.07607225L72.713318,72.56931725C72.709801,72.57136125,72.706284,72.57339125,72.702751,72.57540925L72.375,72.76270325C72.346382,72.77905625,72.313995,72.78765525,72.281036,72.78765525C72.243645,72.78765525,72.207092,72.79872125,72.17598,72.81946225L71.925949,72.98614524999999C71.909538,72.99708525,71.890266,73.00292225,71.870544,73.00292225C71.855034,73.00292225,71.839737,73.00653125,71.825867,73.01346625L71.458595,73.19710125C71.430855,73.21096825000001,71.400276,73.21818925,71.369263,73.21818925C71.329826,73.21818925,71.291275,73.22986225,71.258461,73.25173525L71.041885,73.39611825C71.005363,73.42046725,70.962448,73.43346025,70.918556,73.43346025C70.891891,73.43346025,70.865448,73.43825525,70.840485,73.44761625000001L70.487564,73.57996025C70.461197,73.58984724999999,70.433266,73.59491324999999,70.405106,73.59491324999999C70.362541,73.59491324999999,70.320778,73.60648325,70.284279,73.62838325L70.1745,73.69425225C70.105988,73.73536325,70.030922,73.76438125,69.952576,73.78005225L69.80188,73.81019225L69.624542,73.84566125C69.563507,73.85786825,69.503708,73.87564125,69.445915,73.89875825L69.411591,73.91249125C69.313896,73.95156825000001,69.209633,73.97164925,69.104408,73.97164925C69.031532,73.97164925,68.959641,73.98121625,68.889175,73.99980525000001C68.371841,74.13628725000001,67.848724,74.24982025,67.32135,74.34006925C67.289032,74.34560024999999,67.255959,74.34836924999999,67.223175,74.34836924999999C67.184357,74.34836924999999,67.14563,74.35220325,67.107567,74.35981724999999L66.895714,74.40218725C66.716759,74.43797725,66.534714,74.45600525,66.352211,74.45600525L65.955811,74.45600525C65.829117,74.45600525,65.702591,74.46500025,65.577171,74.48291825C65.451752,74.50083525,65.325226,74.50982625,65.198532,74.50982625L63.076317,74.50982625C62.931824,74.50982625,62.787472,74.50083925,62.644096,74.48291825L62.473808,74.46162824999999C62.443848,74.45788225,62.413681,74.45600525,62.383488,74.45600525C62.342033,74.45600525,62.300163,74.45241125,62.259331,74.44524425C61.951267,74.39117425,61.644482,74.33008625,61.339207,74.26201225C61.276997,74.24814225,61.212658,74.24073425,61.148922,74.24073425C61.069729,74.24073425,60.990921,74.22969825,60.914776,74.20794325L60.756332,74.16267425000001C60.687668,74.14305525,60.616608,74.13310225000001,60.545197,74.13310225000001C60.473789,74.13310225000001,60.402725,74.12315025000001,60.334064,74.10353425L60.100861,74.03690725C60.074181,74.02928525,60.047375,74.02210225,60.020454,74.01537325000001L59.912304,73.98833425000001C59.867813,73.97721125000001,59.824585,73.96599925000001,59.780392,73.95375025C59.420792,73.85409125000001,59.065117,73.74077224999999,58.714146,73.61402125000001C58.678631,73.60119225,58.64225,73.59492125,58.604488,73.59492125C58.570992,73.59492125,58.538433,73.58996225,58.506565,73.57964325C58.401718,73.54569624999999,58.297115,73.51102025,58.192757,73.47562425000001C58.111305,73.44799825,58.032398,73.41116325,57.958649,73.36691325000001L57.93116,73.35041824999999C57.844517,73.29843125,57.750656,73.25955625,57.652634,73.23504625000001C57.607738,73.22381924999999,57.563656,73.20956824999999,57.520687,73.19237925L57.406197,73.14658324999999C57.346306,73.12262725,57.289066,73.09251825,57.235397,73.05674024999999C57.181725,73.02095825,57.124481,72.99084825,57.064587,72.96689225L56.998337,72.94039125C56.923367,72.91040425,56.851715,72.87271525,56.784531,72.82792624999999C56.744293,72.80110525,56.702427,72.77680925,56.659176,72.75518425L56.435482,72.64333725C56.340897,72.59604625,56.24778,72.54587125,56.156265,72.49288525L3.6961832,42.11842395C3.5641739,42.04199075,3.4309027,41.96714495,3.2992656,41.89007565C1.1161758,40.611948749999996,2.5662405e-7,38.93678905,2.5662405e-7,37.16015625L0,48.58185625C0,50.29393825,1.1169926,52.05915725,3.4038138,53.40172025C3.4314463,53.417942249999996,3.4582484,53.43342225,3.4860024,53.449434249999996L55.995083,83.74531925C56.158104,83.83937424999999,56.314709,83.93537125,56.475845,84.03261524999999C56.548855,84.07667525,56.622322,84.11999125,56.696205,84.16255925C56.7519,84.19464525000001,56.806732,84.22364025,56.864223,84.25238825L56.993359,84.31695525C57.06501,84.35277925,57.139107,84.38348725,57.215096,84.40884025C57.246567,84.41934225,57.277721,84.43075925,57.308521,84.44308825L57.448818,84.49924125C57.503796,84.52124425,57.557838,84.54552125000001,57.610802,84.57200225L57.700413,84.61681025C57.731197,84.63220225,57.763039,84.64539325,57.795689,84.65628825L57.879227,84.68416225C57.898281,84.69052125,57.918232,84.69376025,57.93832,84.69376025C57.987839,84.69376025,58.035332,84.71343225,58.070347,84.74844725L58.085987,84.76408725C58.110584,84.78868525,58.14069,84.80785325,58.173393,84.81971025C58.484367,84.93245725,58.799911,85.03169625000001,59.119442,85.11727125C59.137093,85.12200525,59.154358,85.12715525,59.171688,85.13292725L59.252663,85.15989325000001C59.288876,85.17195125,59.326797,85.17810025,59.364967,85.17810025C59.397953,85.17810025,59.430782,85.18269325,59.462502,85.19174625L59.767952,85.27890825C59.783978,85.28348125,59.799793,85.28782625,59.815899,85.29210325C59.979679,85.33558225,60.143196,85.37997425,60.306435,85.42542625C60.35754,85.43965525,60.410904,85.44710925,60.463963,85.44710925C60.517952,85.44710925,60.571674,85.45463525,60.623585,85.46947525L60.803707,85.52095825C60.882195,85.54339225,60.963425,85.55477525,61.045055,85.55477525C61.106411,85.55477525,61.167896,85.56132925,61.227962,85.57384525C61.367241,85.60287124999999,61.506725,85.63060425,61.646542,85.65701725C61.666111,85.66071325,61.685123,85.66439425,61.704647,85.66830025L61.953979,85.71819725C62.126492,85.75272025000001,62.301991,85.77010725,62.477921,85.77010725L62.694736,85.77010725C62.768433,85.77010725,62.841854,85.77911725,62.913364,85.79694325C62.984875,85.81476925,63.058296,85.82378425,63.131992,85.82378425L63.960804,85.82378425C64.087479,85.82378425,64.213989,85.83277925,64.339386,85.85070025C64.464783,85.86862225,64.591301,85.87761725,64.717972,85.87761725L65.069733,85.87761725C65.246353,85.87761725,65.421371,85.87258525,65.597252,85.85644525000001C65.788719,85.83887525,65.979836,85.81667325000001,66.170181,85.78979824999999C66.258965,85.77726325,66.349083,85.77010725,66.438736,85.77010725C66.492264,85.77010725,66.545769,85.76768125000001,66.599075,85.76283225L67.073128,85.71972625000001C67.098419,85.71742625,67.123795,85.71627425,67.149193,85.71627425C67.19548,85.71627425,67.241692,85.71244825,67.287354,85.70483425L67.846535,85.61159125C67.858444,85.60960424999999,67.870499,85.60860825,67.882576,85.60860825C67.906105,85.60860825,67.929489,85.60481625,67.951813,85.59738125L68.027145,85.57229625C68.062172,85.56063424999999,68.098053,85.55172325000001,68.134468,85.54565025L68.291229,85.51949725C68.365341,85.50713325000001,68.437981,85.49220325,68.510475,85.47244624999999C68.615341,85.44387825,68.719521,85.41279225,68.822876,85.37917725C68.901833,85.35349225,68.98317,85.33959924999999,69.0662,85.33959924999999C69.161255,85.33959924999999,69.255432,85.32142625,69.343666,85.28606425000001L69.420349,85.25532925C69.459496,85.23963925000001,69.498352,85.22641725,69.53891,85.21487024999999C69.687279,85.17263425,69.83493,85.12825425,69.981987,85.08162325C70.005119,85.07428325000001,70.02948,85.07043425,70.053749,85.07043425C70.100075,85.07043425,70.145363,85.05673225000001,70.183914,85.03105525000001L70.231827,84.99914525C70.267441,84.97542525,70.30928,84.96276825000001,70.352074,84.96276825000001C70.379639,84.96276825000001,70.406685,84.95764925,70.432251,84.94734925C70.694031,84.84190325,70.952629,84.72888925000001,71.207832,84.60838325C71.239182,84.59357025,71.272812,84.58609425,71.307487,84.58609425C71.343651,84.58609425,71.379318,84.57767525,71.411667,84.56150025L71.791847,84.37141025C71.792709,84.37097925,71.79335,84.37066225000001,71.794212,84.37023125C71.944778,84.29465125,72.093544,84.21545825,72.240303,84.13271725C72.518242,83.97603225,72.792412,83.80620925,73.068222,83.64581325L125.08212,53.39768825C125.11179,53.38043425,125.14315,53.36627225,125.17571,53.35542825L125.20293,53.346365250000005C125.25913,53.327650250000005,125.31017,53.29606225,125.352,53.254118250000005C125.38097,53.22505725,125.41447,53.20088025,125.45117,53.18252725L125.5344,53.14091725C125.58542,53.115407250000004,125.63404,53.085356250000004,125.67967,53.05113125L125.79259,52.96643725C125.81513,52.94953125,125.83814,52.93325025,125.86158,52.917610249999996L125.91594,52.88133425C125.9637,52.84946125,126.0082,52.81295825,126.04881,52.77235725L126.06405,52.75711425C126.12038,52.70078425,126.18543,52.65390425,126.25668,52.61827725C126.32805,52.58259425,126.39319,52.53562025,126.44958,52.47917225L126.52549,52.40318725C126.52568,52.40299625,126.52586,52.40280625,126.52605,52.40261625L126.66846,52.26049825C126.68061,52.24837125,126.69707,52.24156025,126.71424,52.24156025C126.73144,52.24156025,126.74794,52.234722250000004,126.76009,52.22255425L126.88674,52.09577525C126.8972,52.08530425,126.9072,52.07437125,126.91668,52.06300925L127.15651,51.77571625C127.16637,51.76389525,127.18098,51.75706325,127.19638,51.75706325C127.21461,51.75706325,127.23151,51.74750425,127.2409,51.73187825L127.37743,51.50467925C127.38362,51.494364250000004,127.39478,51.48805425,127.40681,51.48805425C127.42574,51.48805425,127.44109,51.47270425,127.44109,51.45376925L127.44109,51.449988250000004C127.44109,51.43989325,127.4451,51.43021025,127.45224,51.423072250000004L127.63581,51.23950625C127.64901,51.226305249999996,127.65643,51.20840025,127.65643,51.18973125C127.65643,51.17375725,127.66186,51.15825925,127.67183,51.14578125L127.85137,50.92115025C127.86436,50.90490025,127.87144,50.88471725,127.87144,50.86391425C127.87144,50.84964525,127.87477,50.83557425,127.88116,50.82281925L127.92522,50.734956249999996C127.92536,50.73468525,127.9255,50.73441325,127.92564,50.73414225L127.95143,50.68247325C127.96986,50.64555325,127.99057,50.60981725,128.01344,50.57547425C128.06212,50.50240325,128.10089,50.42320425,128.12875,50.33994625L128.14053,50.30470725C128.14069,50.30426325,128.14084,50.303819250000004,128.14099,50.30337525L128.18266,50.177969250000004C128.19041,50.15467025,128.20346,50.13349125,128.22079,50.11610425C128.23874,50.09810525,128.25204,50.076429250000004,128.25941,50.05210925C128.29385,49.93859825,128.32283,49.82352825,128.34624,49.70725125C128.35289,49.67420725,128.36115,49.642163249999996,128.37183,49.61019725L128.37555,49.59904125C128.39821,49.53126225,128.40977,49.46026525,128.40977,49.38879825L128.40977,49.36661925C128.40977,49.310258250000004,128.41884,49.25426425,128.43661,49.20077925C128.45439,49.14729425,128.46344,49.09130025,128.46344,49.03493925L128.46344,48.58211025C128.46344,48.58194125,128.46344,48.58177225,128.46344,48.58160325L128.56908,37.53686243C128.56909,37.53551748,128.57111,37.53552726,128.57111,37.53687239';
const DECO_PATH_2 =
  'M125.14282,32.541077C129.69792,35.175663,129.69865,39.414402,125.19846,42.049465C125.18768,42.055782,125.17719,42.061886,125.16638,42.068169L72.726273,72.564102C72.715469,72.570389,72.704971,72.576508,72.69416,72.582787C68.179764,75.206215,60.889172,75.20752,56.318523,72.586716C56.30291,72.577751,56.287796,72.569016,56.272228,72.560005L3.5865555,42.054947C3.5289543,42.021599,3.470938,41.9879,3.4138577,41.953663C-1.0687684,39.264889,-1.0458291,35.163284,3.430064,32.542469C3.4412289,32.535931,3.4519262,32.529709,3.4631109,32.523205L55.791233,2.0923905C55.876312,2.0429125,55.961506,1.9924173,56.046738,1.9432015C60.544937,-0.65423167,67.700966,-0.64771748,72.238052,1.9627441C72.302269,1.9996974,72.365402,2.0367129,72.429558,2.0737925L125.11437,32.524643C125.12396,32.530186,125.13324,32.535534,125.14283,32.54108" fill="url(#master_svg1_12_9415)" fill-opacity="0.30000001192092896"/><path d="M125.19846,42.049465C129.69865,39.414402,129.69792,35.175663,125.14282,32.541077L125.11437,32.524643L72.429558,2.0737925C72.365402,2.0367129,72.302269,1.9996974,72.238052,1.9627441C67.700966,-0.64771748,60.544937,-0.65423167,56.046738,1.9432015C55.961506,1.9924173,55.876312,2.0429125,55.791233,2.0923905L3.4631109,32.523205C3.4519262,32.529709,3.4412289,32.535931,3.430064,32.542469C-1.0458291,35.163284,-1.0687684,39.264889,3.4138577,41.953663C3.470938,41.9879,3.5289543,42.021599,3.5865555,42.054947L56.272228,72.560005C56.287796,72.569016,56.30291,72.577751,56.318523,72.586716C60.889172,75.20752,68.179764,75.206215,72.69416,72.582787C72.704971,72.576508,72.715469,72.570389,72.726273,72.564102L125.16638,42.068169C125.17719,42.061886,125.18768,42.055782,125.19846,42.049465ZM124.49971,33.654392L124.49909,33.654037L124.48587,33.646397L124.47099,33.637798L71.784081,3.1857378L71.689484,3.1308243L71.596855,3.0771635Q68.49173,1.2905972,64.126373,1.2857254Q59.764908,1.2808577,56.694221,3.0539765L56.566437,3.1284645L56.437576,3.2038307L4.1096849,33.63451L4.0954256,33.642807L4.0797243,33.651974Q1.3539562,35.24802,1.3482252,37.226307Q1.3424733,39.211933,4.0752039,40.851082Q4.1289716,40.883331,4.2307892,40.94228L56.915604,71.446846L56.936375,71.458855L56.958073,71.471352Q60.088974,73.266602,64.527145,73.265617Q68.961914,73.264641,72.047874,71.471313L72.0634,71.46228L72.079926,71.452667L124.51971,40.956924L124.53374,40.948761L124.5488,40.939964Q127.28902,39.335434,127.28068,37.300365Q127.27231,35.258236,124.49971,33.654392Z';

// 装饰元素的偏移量 - 改为正值
const DECO_OFFSET_X = 60 + W_PATH_W / 2;
const DECO_OFFSET_Y = 40 + W_PATH_W / 2;

export interface SequenceZigzagStepsProps extends BaseStructureProps {
  dx?: number;
  dy?: number;
  iconSize?: number;
}

// 滤镜定义
// const GlowFilter = (
//   <filter
//     id="sequence-zigzag-glow-filter"
//     x="-50%"
//     y="-50%"
//     width="200%"
//     height="200%"
//   >
//     <feGaussianBlur in="SourceGraphic" stdDeviation="15" result="blur" />
//   </filter>
// );

export const SequenceZigzagSteps: ComponentType<SequenceZigzagStepsProps> = (
  props,
) => {
  const { Title, Item, data, options, dx = DX, dy = DY, iconSize = 30 } = props;
  const { title, desc, items = [] } = data;
  const titleContent = Title ? <Title title={title} desc={desc} /> : null;
  const colorPrimary = getColorPrimary(options);

  if (items.length === 0) {
    const btnAddElement = <BtnAdd indexes={[0]} x={0} y={0} />;
    return (
      <FlexLayout
        id="infographic-container"
        flexDirection="column"
        justifyContent="center"
        alignItems="center"
      >
        {titleContent}
        <Group>
          <BtnsGroup>{btnAddElement}</BtnsGroup>
        </Group>
      </FlexLayout>
    );
  }

  const itemBounds = getElementBounds(
    <Item indexes={[0]} data={data} datum={items[0]} />,
  );
  const btnBounds = getElementBounds(<BtnAdd indexes={[0]} />);

  const btnElements: JSXElement[] = [];
  const itemElements: JSXElement[] = [];
  const pathElements: JSXElement[] = [];
  const decoElements: JSXElement[] = [];
  const iconElements: JSXElement[] = [];

  let currentX = 0;
  let currentY = 0;
  let pathD = '';
  let minPathY = Infinity;
  let maxItemY = -Infinity;
  let minDecoX = Infinity;
  let minDecoY = Infinity;

  const pathPoints: Array<{ x: number; y: number }> = [];

  // Pass 1: 计算路径点和装饰元素的边界
  items.forEach((item, index) => {
    const cx = currentX;
    const cy = currentY;

    pathPoints.push({ x: cx, y: cy });
    minPathY = Math.min(minPathY, cy);

    // 计算装饰元素的位置
    const decoX = cx - DECO_OFFSET_X;
    const decoY = cy - DECO_OFFSET_Y;

    minDecoX = Math.min(minDecoX, decoX);
    minDecoY = Math.min(minDecoY, decoY);

    const isPeak = index % 2 === 0;

    if (index < items.length - 1) {
      currentX += dx;
      currentY = isPeak ? currentY + dy : currentY - dy;
    }
  });

  // 计算偏移量以确保所有元素都在正坐标
  const offsetX = Math.max(0, -minDecoX);
  const offsetY = Math.max(0, -minDecoY);

  currentX = 0;
  currentY = 0;

  // Pass 2: 放置元素，应用偏移量
  items.forEach((item, index) => {
    const indexes = [index];
    const pathPoint = pathPoints[index];
    const cx = pathPoint.x + offsetX;
    const cy = pathPoint.y + offsetY;

    const currentColor = getPaletteColor(options, indexes);

    // 装饰元素 - 确保坐标为正值
    const decoX = Math.max(0, cx - DECO_OFFSET_X);
    const decoY = Math.max(0, cy - DECO_OFFSET_Y);

    const { colorPrimaryBg } = getThemeColors({
      colorPrimary: currentColor,
    });
    
    // 生成唯一 ID
    const gradientSideId = `zigzag-gradient-side-${index}`;
    const gradientTopFillId = `zigzag-gradient-top-fill-${index}`;
    const gradientTopStrokeId = `zigzag-gradient-top-stroke-${index}`;

    decoElements.push(
      <ShapesGroup x={decoX} y={decoY} width={140} height={110}>
        <Defs>
          {/* 侧面渐变: 90deg (左->右) */}
          <linearGradient id={gradientSideId} x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor={currentColor || colorPrimary} stopOpacity={0.4} />
            <stop offset="100%" stopColor={currentColor || colorPrimary} stopOpacity={0.12} />
          </linearGradient>

          {/* 顶部填充渐变: 180deg (上->下) */}
          <linearGradient id={gradientTopFillId} x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor={currentColor || colorPrimary} stopOpacity={0.3} />
            <stop offset="100%" stopColor={currentColor || colorPrimary} stopOpacity={0.09} />
          </linearGradient>

          {/* 顶部描边渐变: 270deg (右->左) -> x1=100% x2=0% */}
          <linearGradient id={gradientTopStrokeId} x1="100%" y1="0%" x2="0%" y2="0%">
            <stop offset="-2%" stopColor={currentColor || colorPrimary} stopOpacity={0.15} />
            <stop offset="100%" stopColor={currentColor || colorPrimary} stopOpacity={0.5} />
          </linearGradient>
        </Defs>

        {/* 侧面 */}
        <Path d={DECO_PATH_1} fill={`url(#${gradientSideId})`} />
        <Path d={DECO_PATH_2} fill={'#fff'} />
        {/* 顶部: 填充+描边+透明度 */}
        <Path 
          d={DECO_PATH_2} 
          fill={`url(#${gradientTopFillId})`} 
          stroke={`url(#${gradientTopStrokeId})`}
          strokeWidth={1.29}
          opacity={0.8}
        />
      </ShapesGroup>,
    );

    // Icon 元素
    if (item.icon) {
      const iconX = Math.max(0, cx - iconSize / 2 - W_PATH_W / 2);
      const iconY = Math.max(0, cy - iconSize / 2 - W_PATH_W / 2);

      iconElements.push(
        <ItemIcon
          x={iconX}
          y={iconY}
          size={iconSize}
          indexes={indexes}
          fill={currentColor}
        />,
      );
    }

    // Item 元素和按钮
    const itemX = cx - itemBounds.width / 2 - W_PATH_W / 2;
    const itemY = Math.max(0, cy + ITEM_TO_PATH_GAP - W_PATH_W / 2);

    maxItemY = Math.max(maxItemY, itemY + itemBounds.height);

    if (index === 0) {
      pathD = `M ${cx} ${cy}`;
    } else {
      pathD += ` L ${cx} ${cy}`;
    }

    itemElements.push(
      <Item indexes={indexes} datum={item} data={data} x={itemX} y={itemY} />,
    );

    btnElements.push(
      <BtnRemove
        indexes={indexes}
        x={Math.max(0, itemX + itemBounds.width - btnBounds.width / 2)}
        y={Math.max(0, itemY + itemBounds.height - btnBounds.height / 2)}
      />,
    );

    if (index < items.length - 1) {
      const nextPoint = pathPoints[index + 1];
      const nextCx = nextPoint.x + offsetX;
      const nextCy = nextPoint.y + offsetY;
      const btnAddX = Math.max(0, cx + (nextCx - cx) / 2 - btnBounds.width / 2);
      const btnAddY = Math.max(
        0,
        cy + (nextCy - cy) / 2 - btnBounds.height / 2,
      );

      btnElements.push(
        <BtnAdd indexes={[index + 1]} x={btnAddX} y={btnAddY} />,
      );
    } else {
      btnElements.push(
        <BtnAdd
          indexes={[items.length]}
          x={Math.max(0, itemX + itemBounds.width + dx / 4)}
          y={Math.max(0, itemY + itemBounds.height / 2 - btnBounds.height / 2)}
        />,
      );
    }
  });

  if (pathD) {
    const finalX = (pathPoints[pathPoints.length - 1]?.x || 0) + offsetX;
    pathElements.push(
      <Path
        d={pathD}
        stroke="#f3f2f1"
        strokeWidth={W_PATH_W}
        fill="none"
        width={finalX}
        height={maxItemY - Math.min(minPathY + offsetY, 0)}
      />,
    );
  }

  return (
    <FlexLayout
      id="infographic-container"
      flexDirection="column"
      justifyContent="center"
      alignItems="center"
      gap={30}
    >
      {titleContent}
      <Group x={0} y={0}>
        <Group>{[...pathElements, ...decoElements, ...iconElements]}</Group>
        <ItemsGroup>{itemElements}</ItemsGroup>
        <BtnsGroup>{btnElements}</BtnsGroup>
      </Group>
    </FlexLayout>
  );
};

registerStructure('sequence-zigzag-steps', {
  component: SequenceZigzagSteps,
  composites: ['title', 'item'],
});
